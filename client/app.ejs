<script type="module">
import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
;

async function apiCall(url, payload, method = "POST") {
  try {
    const response = await fetch(url, {
      method: method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    return await response.json();
    // if (response.ok) {
    //   return json;
    // } else {
    //   console.log("API CALL: !response.ok", json);
    // }
  } catch (error) {
    console.log("API CALL ERROR: ", error);
    return error;
    //throw new Error(error.message);
  }
}

createApp({
  data() {
    return {
      // the board from server, this is initialization version
      site: {
        id: '',
        name: '',
        zones: [],
        clinicians: [],
        shift_details: []
      },
      shifts: [],
      events: [],
      board: {
        rotations: [],
        events: []
      },
      
      // flags for UI popovers
      ui: {
        showAddShiftPopover: false,
        showAssignPopover: false,
        showAssignMini: false,
        showMovePopover: false,
        showReassignPopover: false,
        showWhatsNew: false,
      },
      // variables for form control with v-model
      forms: {
        addShift: {
          clinicianId: "",
          shiftTypeId: "",
          zoneId: "",
        },
        assign: {
          shiftId: "",
          type: "",
          room: "",
        },
        assignTypes: [
          { type: "walkin", icon: "./icons/walkin.svg", tip: "walk in" },
          { type: "ambo", icon: "./icons/ambo.svg", tip: "ambo" },
          { type: "ft", icon: "./icons/ft.svg", tip: "fast track" },
          // { type: "bonus", icon: "./icons/bonus.svg", tip: "bonus" },
        ],
      },
    };
  },
  methods: {
    // HELPERS
    getShiftsForZone(zoneId) {
      return this.shifts.filter(s=>s.zone_id===zoneId);
    },

    // findRotationByName(name) {
    //   return this.board.rotations.filter((r) => r.name === name);
    // },

    // findShiftsByRotation(rotationId) {
    //   return this.board.shifts
    //     .filter((s) => s.rotationId === rotationId)
    //     .sort((a, b) => a.order - b.order);
    // },

    // getShiftsSortedByDoc() {
    //   return this.board.shifts.toSorted((a, b) => {
    //     const nameA = a.doctor.last.toUpperCase();
    //     const nameB = b.doctor.last.toUpperCase();
    //     return nameA < nameB ? -1 : nameA > nameB ? 1 : 0;
    //   });
    // },

    // SERVER
    async checkLoginStatus() {
      console.log("Checking login status");
      const res = await apiCall("checklogin");
      if (res.status === "success" && res.payload) {
        //this.user = { loggedIn: true, ...res.payload };
        this.nurse = res.payload.username === "nurse" ? true : false;
      }
      if (res.status === "error") {
        this.setError(res);
      }
    },

    // init board, function to get site, shifts, events
    async getAppSection(section, apiurl) {
      const { data, error } = await apiCall(apiurl);
      this[section] = data;
      console.log('### '+ section + ': ', data);
    },

    // handleNewState(state) {
    //   this.board = state;
    // },

    // API Calls
    addShift() {
      const f = this.forms.addShift;
      console.log(f);
      apiCall("api/addshift", {
        clinicianId: f.clinicianId,
        shiftTypeId: f.shiftTypeId,
        zoneId: f.zoneId
      });
      this.toggleAddShiftPopover();
    },

    moveShift(shiftId, offset) {
      apiCall("api/moveShift", { shiftId, offset });
    },

    moveShiftToRotation(rotationId, shiftId) {
      apiCall("api/moveShiftToRotation", { rotationId, shiftId });
      this.toggleMovePopover(shiftId);
    },

    moveNext(cycle, rotationId, offset) {
      apiCall("api/moveNext", { cycle, rotationId, offset });
    },

    assignPatient(shiftId) {
      this.forms.assign.shiftId = shiftId;
      apiCall("api/assignPatient", this.forms.assign);
      this.toggleAssign(shiftId);
    },

    assignPatientMini(shiftId) {
      this.forms.assign.shiftId = shiftId;
      apiCall("api/assignPatient", {...this.forms.assign, movePointer: false });
      this.toggleAssignMini(shiftId);
    },

    assignPatientComplete() {
      return !!this.forms.assign.type && !!this.forms.assign.room;
    },

    reassign(eventId, shiftId) {
      apiCall("api/reassign", { eventId, shiftId });
      this.toggleReassignPopover(eventId);
    },

    staffMidlevel(rotationId, shiftId) {
      apiCall("api/staffMidlevel", { rotationId, shiftId});
    },

    toggleSkip(shiftId) {
      apiCall("api/toggleSkip", {shiftId});
    },  

    undo() {
      apiCall("api/undo");
    },

    // POPOVERS & UI
    closeDropdown(event) {
      event.target.closest("details").removeAttribute("open");
    },

    uiTogglerByShift(flag, shiftId) {
      this.ui[flag] = !this.ui[flag] ? shiftId : false;
    },

    // utility to reset the modeled form data
    formDataReset(form) {
      Object.keys(form).forEach((key) => {
        form[key] = "";
      });
    },

    toggleAddShiftPopover() {
      this.ui.showAddShiftPopover = !this.ui.showAddShiftPopover;
      this.formDataReset(this.forms.addShift);
    },

    addShiftComplete() {
      return Object.values(this.forms.addShift).every(Boolean);
    },

    toggleAssign(shiftId) {
      this.uiTogglerByShift("showAssignPopover", shiftId);
      this.formDataReset(this.forms.assign);
    },

    assignPopoverOpen(shiftId) {
      return shiftId === this.ui.showAssignPopover;
    },

    toggleAssignMini(shiftId) {
      this.uiTogglerByShift("showAssignMini", shiftId);
      this.formDataReset(this.forms.assign);
    },

    assignMiniOpen(shiftId) {
      return shiftId === this.ui.showAssignMini;
    },

    toggleMovePopover(shiftId) {
      this.uiTogglerByShift("showMovePopover", shiftId);
    },

    movePopoverOpen(shiftId) {
      return shiftId === this.ui.showMovePopover;
    },

    toggleReassignPopover(eventId) {
      this.uiTogglerByShift("showReassignPopover", eventId);
    },

    reassignPopoverOpen(eventId) {
      return eventId === this.ui.showReassignPopover;
    },

    // SHIFT STYLES HELPERS
    isNext(zone, shift) {
      return shift.id === zone.next_pt_shift_id;
    },

    isNextSupervisor(zone, shift) {
      return shift.id === zone.next_supervisor_shift_id;
    },

    isDocShift(shift) {
      return shift.clinician.clinician_type_id === 1;
    },

    isMidlevelShift(shift) {
      return shift.clinician.clinician_type_id === 2;
    },

    // getShiftClasses(rotation, shift) {

    //   // const shiftType = {
    //   //   Off: "shiftOff",
    //   //   "Fast Track": "shiftFastTrack",
    //   //   Main: "shiftMain",
    //   // };
    //   // const next = this.isNext(rotation, shift) ? "shiftNext" : "";
    //   // const midlevel = shift.doctor.app ? "shiftApp" : "";

    //   // return `${shiftType[rotation.name]} ${next} ${midlevel}`;
    // },
  },

  async mounted() {
    this.checkLoginStatus();
    this.getAppSection('site', 'api/getsitedetails')
    this.getAppSection('shifts', 'api/getshifts')
    this.getAppSection('events', 'api/getevents')
  },
}).mount("#app");
</script>
